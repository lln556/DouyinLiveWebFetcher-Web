<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直播数据统计</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .tab-btn {
            @apply px-4 py-2 rounded-t-lg;
        }
        .tab-btn.active {
            @apply bg-blue-500 text-white;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            border-radius: 8px;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
            max-width: 1200px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- 头部 -->
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold">直播数据统计</h1>
            <a href="/" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                返回首页
            </a>
        </div>

        <!-- 房间选择 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex flex-wrap items-center gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">选择房间</label>
                    <select
                        v-model="selectedRoomId"
                        @change="loadRoomData"
                        class="px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="">全部房间</option>
                        {% raw %}
                        <option v-for="room in rooms" :key="room.live_id" :value="room.live_id">
                            {{ room.anchor_name || room.live_id }} ({{ room.live_id }})
                        </option>
                        {% endraw %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">时间范围</label>
                    <select
                        v-model="timeRange"
                        @change="onTimeRangeChange"
                        class="px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                        <option value="today">今天</option>
                        <option value="yesterday">昨天</option>
                        <option value="7days">最近7天</option>
                        <option value="30days">最近30天</option>
                        <option value="thisMonth">本月</option>
                        <option value="lastMonth">上月</option>
                        <option value="custom">自定义</option>
                    </select>
                </div>
                <div v-if="timeRange === 'custom'" class="flex gap-2">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">开始日期</label>
                        <input
                            v-model="customStartDate"
                            type="date"
                            class="px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">结束日期</label>
                        <input
                            v-model="customEndDate"
                            type="date"
                            class="px-3 py-2 border rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                </div>
                <div class="self-end">
                    <button
                        @click="loadData"
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        查询
                    </button>
                </div>
            </div>
        </div>

        <!-- 统计概览 - 查询后显示 -->
        <div v-if="hasSearched">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="text-sm text-gray-600">直播场次</div>
                    <div class="text-2xl font-bold text-blue-600" v-text="stats.total_sessions || 0"></div>
                    <div class="text-xs text-gray-500 mt-1">
                        直播中: <span class="text-green-600" v-text="stats.live_sessions || 0"></span> |
                        已结束: <span class="text-gray-600" v-text="stats.ended_sessions || 0"></span>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="text-sm text-gray-600">总收入</div>
                    <div class="text-2xl font-bold text-yellow-600" v-text="formatIncome(stats.total_income)"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="text-sm text-gray-600">总礼物数</div>
                    <div class="text-2xl font-bold text-pink-600" v-text="formatNumber(stats.total_gift_count)"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="text-sm text-gray-600">总弹幕数</div>
                    <div class="text-2xl font-bold text-green-600" v-text="formatNumber(stats.total_chat_count)"></div>
                </div>
            </div>

            <!-- 详细统计 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="text-sm text-gray-600">峰值观看人数</div>
                    <div class="text-2xl font-bold text-purple-600" v-text="formatNumber(stats.peak_viewer_max)"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="text-sm text-gray-600">总直播时长</div>
                    <div class="text-2xl font-bold text-indigo-600" v-text="formatDuration(stats.total_duration_seconds)"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="text-sm text-gray-600">平均时长</div>
                    <div class="text-2xl font-bold text-teal-600" v-text="formatDuration(stats.avg_duration_seconds)"></div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4">
                    <div class="text-sm text-gray-600">场均收入</div>
                    <div class="text-2xl font-bold text-orange-600" v-text="formatAvgIncome()"></div>
                </div>
            </div>

            <!-- 场次列表 -->
            <div v-if="selectedRoomId" class="bg-white rounded-lg shadow-md">
                <div class="px-6 py-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold">直播场次列表</h2>
                    <span class="text-sm text-gray-500">共 <span v-text="sessions.length"></span> 场</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">场次ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">开始时间</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">结束时间</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">状态</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">收入</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">礼物数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">弹幕数</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">峰值观看</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <tr v-if="sessions.length === 0">
                                <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                                    暂无数据
                                </td>
                            </tr>
                            <tr v-for="session in sessions" :key="session.id" class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap text-sm" v-text="session.id"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm" v-text="formatDateTime(session.start_time)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm" v-text="formatDateTime(session.end_time)"></td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span :class="['px-2 py-1 text-xs rounded-full', getSessionStatusClass(session.status)]">
                                        <span v-text="getSessionStatusText(session.status)"></span>
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600" v-text="formatIncome(session.total_income)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm" v-text="formatNumber(session.total_gift_count)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm" v-text="formatNumber(session.total_chat_count)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm" v-text="formatNumber(session.peak_viewer_count)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <button
                                        @click="viewSessionDetail(session)"
                                        class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                                        查看详情
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 场次详情模态框 -->
        {% raw %}
        <div v-if="showSessionModal" class="modal-overlay" @click.self="closeSessionModal">
            <div class="modal-content">
                <div class="px-6 py-4 border-b flex justify-between items-center sticky top-0 bg-white">
                    <h2 class="text-xl font-bold">场次详情 #{{ sessionDetail.id }}</h2>
                    <button @click="closeSessionModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>

                <div v-if="sessionDetailLoading" class="p-8 text-center">
                    <div class="text-gray-500">加载中...</div>
                </div>

                <div v-else class="p-6">
                    <!-- 场次基本信息 -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600">开始时间</div>
                            <div class="text-base font-semibold" v-text="formatDateTime(sessionDetail.start_time)"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600">结束时间</div>
                            <div class="text-base font-semibold" v-text="formatDateTime(sessionDetail.end_time)"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600">状态</div>
                            <div>
                                <span :class="['px-2 py-1 text-xs rounded-full', getSessionStatusClass(sessionDetail.status)]">
                                    <span v-text="getSessionStatusText(sessionDetail.status)"></span>
                                </span>
                            </div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600">峰值观看</div>
                            <div class="text-base font-semibold text-purple-600" v-text="formatNumber(sessionDetail.peak_viewer_count)"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-yellow-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600">总收入</div>
                            <div class="text-xl font-bold text-yellow-600" v-text="formatIncome(sessionDetail.total_income)"></div>
                        </div>
                        <div class="bg-pink-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600">礼物数</div>
                            <div class="text-xl font-bold text-pink-600" v-text="formatNumber(sessionDetail.total_gift_count)"></div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-sm text-gray-600">弹幕数</div>
                            <div class="text-xl font-bold text-green-600" v-text="formatNumber(sessionDetail.total_chat_count)"></div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="border-b mb-4">
                        <div class="flex gap-4">
                            <button
                                v-for="tab in ['chats', 'gifts', 'contributors']"
                                :key="tab"
                                @click="sessionDetailTab = tab"
                                :class="['tab-btn', { active: sessionDetailTab === tab }]">
                                {{ tab === 'chats' ? '弹幕记录' : tab === 'gifts' ? '礼物记录' : '贡献榜' }}
                            </button>
                        </div>
                    </div>

                    <!-- 弹幕记录 -->
                    <div v-if="sessionDetailTab === 'chats'" class="max-h-96 overflow-y-auto">
                        <div v-if="sessionDetailChats.length === 0" class="text-center py-8 text-gray-500">
                            暂无弹幕记录
                        </div>
                        <div v-else class="space-y-2">
                            <div v-for="chat in sessionDetailChats" :key="chat.id" class="bg-gray-50 rounded p-3">
                                <div class="flex items-center gap-2">
                                    <img v-if="chat.user_level" :src="'/level_img/level_' + chat.user_level + '.png'" style="width: 32px; height: 32px; object-fit: contain;">
                                    <span class="font-medium text-blue-600" v-text="chat.nickname || chat.user_id"></span>
                                    <span class="text-gray-400 text-sm" v-text="formatDateTime(chat.created_at)"></span>
                                </div>
                                <div class="text-gray-700 mt-1" v-text="chat.content"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 礼物记录 -->
                    <div v-if="sessionDetailTab === 'gifts'" class="max-h-96 overflow-y-auto">
                        <div v-if="sessionDetailGifts.length === 0" class="text-center py-8 text-gray-500">
                            暂无礼物记录
                        </div>
                        <div v-else class="space-y-2">
                            <div v-for="gift in sessionDetailGifts" :key="gift.id" class="bg-yellow-50 rounded p-3">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <img v-if="gift.user_level" :src="'/level_img/level_' + gift.user_level + '.png'" style="width: 32px; height: 32px; object-fit: contain;">
                                        <span class="font-medium text-blue-600" v-text="gift.nickname || gift.user_id"></span>
                                        <span class="text-gray-400 text-sm" v-text="formatDateTime(gift.created_at)"></span>
                                    </div>
                                    <div class="text-yellow-600 font-bold" v-text="gift.diamond_count + ' 钻石'"></div>
                                </div>
                                <div class="text-gray-700 mt-1">
                                    送出 <span class="font-semibold text-pink-600" v-text="gift.gift_name"></span>
                                    <span v-if="gift.combo_count > 1" class="text-sm text-gray-500"> (连击 x{{ gift.combo_count }})</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 贡献榜 -->
                    <div v-if="sessionDetailTab === 'contributors'" class="max-h-96 overflow-y-auto">
                        <div v-if="sessionDetailContributors.length === 0" class="text-center py-8 text-gray-500">
                            暂无贡献榜数据
                        </div>
                        <div v-else>
                            <table class="w-full">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">排名</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">用户</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">礼物数</th>
                                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">贡献值</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    <tr v-for="(contributor, index) in sessionDetailContributors" :key="contributor.user_id" class="hover:bg-gray-50">
                                        <td class="px-4 py-2">
                                            <span v-if="index < 3" :class="['font-bold', index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : 'text-orange-400']">
                                                {{ index + 1 }}
                                            </span>
                                            <span v-else v-text="index + 1"></span>
                                        </td>
                                        <td class="px-4 py-2">
                                            <div class="flex items-center gap-2">
                                                <img v-if="contributor.user_avatar" :src="contributor.user_avatar" class="w-8 h-8 rounded-full">
                                                <div v-else class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-gray-500 text-xs">
                                                    {{ (contributor.nickname || contributor.user_id || '').substring(0, 1) }}
                                                </div>
                                                <span class="font-medium text-blue-600" v-text="contributor.nickname || contributor.user_id"></span>
                                                <img v-if="contributor.user_level" :src="'/level_img/level_' + contributor.user_level + '.png'" style="width: 32px; height: 32px; object-fit: contain;">
                                            </div>
                                        </td>
                                        <td class="px-4 py-2 text-right" v-text="contributor.gift_count || 0"></td>
                                        <td class="px-4 py-2 text-right font-semibold text-yellow-600" v-text="formatNumber(contributor.contribution_value)"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endraw %}
    </div>

    <script src="/static/js/stats.js"></script>
</body>
</html>
