<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>直播间详情</title>
    <meta name="live-id" content="{{ live_id }}">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* 消息容器 */
        .messages-container {
            height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #CBD5E0 #EDF2F7;
        }
        @media (min-width: 768px) {
            .messages-container {
                height: 500px;
            }
        }
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        .messages-container::-webkit-scrollbar-track {
            background: #EDF2F7;
            border-radius: 3px;
        }
        .messages-container::-webkit-scrollbar-thumb {
            background-color: #CBD5E0;
            border-radius: 3px;
        }

        /* 贡献榜容器 */
        .contributor-container {
            height: 400px;
            overflow-y: auto;
        }
        @media (min-width: 768px) {
            .contributor-container {
                height: 500px;
            }
        }

        /* 消息样式 */
        .message {
            padding: 10px 14px;
            margin: 6px 0;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        .message:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chat-message {
            background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
            border-left: 4px solid #2196F3;
        }
        .gift-message {
            background: linear-gradient(135deg, #FCE4EC 0%, #FFF3E0 100%);
            border-left: 4px solid #E91E63;
        }
        .gift-user-message {
            background: linear-gradient(135deg, #FFF9C4 0%, #FFF8E1 100%);
            border-left: 4px solid #FFC107;
        }

        /* 用户高亮 */
        .user-highlight {
            font-weight: 600;
            color: #4A90E2;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .user-highlight:hover {
            color: #2563EB;
            text-decoration: underline;
        }

        /* 用户等级图标 */
        .user-level-icon {
            height: 18px;
            vertical-align: middle;
            margin-right: 4px;
            display: inline-block;
        }

        /* 粉丝团等级图标 */
        .fans-club-icon {
            height: 18px;
            vertical-align: middle;
            margin-right: 2px;
            display: inline-block;
        }

        /* 美化标签按钮 */
        .tab-button {
            position: relative;
            padding: 12px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            color: #3B82F6;
            border-bottom-color: #3B82F6;
            background: linear-gradient(to top, rgba(59, 130, 246, 0.08), transparent);
        }
        .tab-button:not(.active):hover {
            background: rgba(0, 0, 0, 0.03);
        }
        .tab-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 10px;
            margin-left: 6px;
        }
        .tab-all .tab-badge { background: #6366F1; color: white; }
        .tab-chat .tab-badge { background: #3B82F6; color: white; }
        .tab-gift .tab-badge { background: #EC4899; color: white; }

        /* 卡片悬浮效果 */
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* 按钮美化 */
        .btn-primary {
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        /* 移动端优化 */
        @media (max-width: 767px) {
            .mobile-stack {
                flex-direction: column;
                gap: 8px;
            }
            .mobile-stack button {
                width: 100%;
            }
            .mobile-full {
                width: 100%;
            }
        }

        /* 贡献榜排名样式 */
        .rank-badge {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 12px;
        }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: white; }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; }
        .rank-other { background: linear-gradient(135deg, #E5E7EB, #D1D5DB); color: #6B7280; }

        /* 动画效果 */
        @keyframes pulse-border {
            0%, 100% { border-color: rgba(59, 130, 246, 0.3); }
            50% { border-color: rgba(59, 130, 246, 0.8); }
        }
        .monitoring-pulse {
            animation: pulse-border 2s ease-in-out infinite;
        }

        /* 用户消息模态框样式 */
        .user-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            animation: fadeIn 0.2s ease-out;
        }
        .user-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideIn 0.2s ease-out;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .user-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            border-radius: 16px 16px 0 0;
            color: white;
        }
        .user-avatar-large {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 3px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
        }
        .user-stats-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 12px 16px;
            backdrop-filter: blur(10px);
        }
        .user-tab-button {
            padding: 12px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            color: #6B7280;
        }
        .user-tab-button:hover {
            background: rgba(0, 0, 0, 0.03);
        }
        .user-tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: linear-gradient(to top, rgba(102, 126, 234, 0.08), transparent);
        }
        .user-message-card {
            padding: 14px 18px;
            margin: 10px 0;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        .user-message-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .user-chat-card {
            background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
            border-left: 4px solid #2196F3;
        }
        .user-gift-card {
            background: linear-gradient(135deg, #FCE4EC 0%, #FFF3E0 100%);
            border-left: 4px solid #E91E63;
        }
        .user-messages-body {
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        .user-messages-list {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #CBD5E0 #EDF2F7;
        }
        .user-messages-list::-webkit-scrollbar {
            width: 6px;
        }
        .user-messages-list::-webkit-scrollbar-track {
            background: #EDF2F7;
            border-radius: 3px;
        }
        .user-messages-list::-webkit-scrollbar-thumb {
            background-color: #CBD5E0;
            border-radius: 3px;
        }
        .user-messages-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-messages-fade {
            animation: userMsgFadeIn 0.2s ease-out;
        }
        @keyframes userMsgFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .user-modal-close-btn {
            transition: all 0.2s ease;
        }
        .user-modal-close-btn:hover {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-3 sm:px-4 py-4 sm:py-6 max-w-7xl">
        <!-- 头部 -->
        <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex-1">
                    <div class="flex flex-wrap items-center gap-2 sm:gap-4 mb-2">
                        <h1 class="text-xl sm:text-2xl font-bold text-gray-800" v-text="live_id"></h1>
                        <span v-if="room" :class="['px-2 sm:px-3 py-1 rounded-full text-xs sm:text-sm font-medium', getStatusClass(room.status), room.status === 'monitoring' ? 'monitoring-pulse border-2' : '']">
                            <span v-text="getStatusText(room.status)"></span>
                        </span>
                    </div>
                    <p v-if="room && room.anchor_name" class="text-gray-600 text-sm sm:text-base">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                        </svg>
                        <span v-text="room.anchor_name"></span>
                    </p>
                </div>
                <div class="flex flex-wrap gap-2 w-full sm:w-auto mobile-stack">
                    <button
                        v-if="room && room.status !== 'monitoring'"
                        @click="startMonitoring"
                        class="btn-primary flex-1 sm:flex-none px-4 sm:px-6 py-2.5 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl hover:from-green-600 hover:to-green-700 font-medium">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
                        </svg>
                        启动监控
                    </button>
                    <button
                        v-if="room && room.status === 'monitoring'"
                        @click="stopMonitoring"
                        class="btn-primary flex-1 sm:flex-none px-4 sm:px-6 py-2.5 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:from-red-600 hover:to-red-700 font-medium">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z"/>
                        </svg>
                        停止监控
                    </button>
                    <a href="/" class="btn-primary flex-1 sm:flex-none px-4 sm:px-6 py-2.5 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl hover:from-gray-600 hover:to-gray-700 font-medium text-center">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"/>
                        </svg>
                        返回列表
                    </a>
                </div>
            </div>
        </div>

        <!-- 统计卡片 -->
        <div class="grid grid-cols-3 gap-2 sm:gap-4 mb-4 sm:mb-6">
            <div class="stat-card bg-white rounded-xl shadow-md p-3 sm:p-4">
                <div class="flex items-center mb-1">
                    <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center mr-2">
                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                        </svg>
                    </div>
                    <div class="text-xs text-gray-500">当前观看</div>
                </div>
                <div class="text-lg sm:text-2xl font-bold text-blue-600" v-text="formatNumber(stats.currentUserCount)"></div>
            </div>
            <div class="stat-card bg-white rounded-xl shadow-md p-3 sm:p-4">
                <div class="flex items-center mb-1">
                    <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center mr-2">
                        <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <div class="text-xs text-gray-500">累计观看</div>
                </div>
                <div class="text-lg sm:text-2xl font-bold text-green-600" v-text="formatNumber(stats.totalUserCount)"></div>
            </div>
            <div class="stat-card bg-white rounded-xl shadow-md p-3 sm:p-4">
                <div class="flex items-center mb-1">
                    <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center mr-2">
                        <svg class="w-4 h-4 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                    </div>
                    <div class="text-xs text-gray-500">贡献者</div>
                </div>
                <div class="text-lg sm:text-2xl font-bold text-purple-600" v-text="formatNumber(stats.contributorCount)"></div>
            </div>
        </div>

        <!-- 当场直播统计 -->
        <div v-if="currentSession" class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                <h2 class="text-lg font-bold text-gray-800">
                    <svg class="w-5 h-5 inline mr-2 text-pink-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"/>
                    </svg>
                    当场直播数据
                </h2>
                <span :class="['px-3 py-1 rounded-full text-xs font-medium', getSessionStatusClass(currentSession.status)]">
                    <span v-text="getSessionStatusText(currentSession.status)"></span>
                </span>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 sm:gap-4">
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-3">
                    <div class="text-xs text-blue-600 mb-1">开播时间</div>
                    <div class="text-sm font-semibold text-gray-800" v-text="formatDateTime(currentSession.start_time)"></div>
                </div>
                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-3">
                    <div class="text-xs text-indigo-600 mb-1">直播时长</div>
                    <div class="text-sm font-semibold text-indigo-700" v-text="getDuration(currentSession.start_time, currentSession.end_time)"></div>
                </div>
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-3">
                    <div class="text-xs text-yellow-600 mb-1">本场收入</div>
                    <div class="text-sm font-semibold text-yellow-700" v-text="formatIncome(currentSession.total_income)"></div>
                </div>
                <div class="bg-gradient-to-br from-pink-50 to-pink-100 rounded-lg p-3">
                    <div class="text-xs text-pink-600 mb-1">本场礼物</div>
                    <div class="text-sm font-semibold text-pink-700" v-text="formatNumber(currentSession.total_gift_count)"></div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-3 col-span-2 sm:col-span-1">
                    <div class="text-xs text-green-600 mb-1">本场弹幕</div>
                    <div class="text-sm font-semibold text-green-700" v-text="formatNumber(currentSession.total_chat_count)"></div>
                </div>
            </div>
            <div v-if="currentSession.peak_viewer_count" class="mt-4 pt-4 border-t border-gray-100">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                    </svg>
                    <span class="text-sm text-gray-600">峰值观看人数</span>
                </div>
                <div class="text-xl sm:text-2xl font-bold text-purple-600 mt-1" v-text="formatNumber(currentSession.peak_viewer_count)"></div>
            </div>
        </div>

        <!-- 主内容区 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
            <!-- 左侧：消息区域 -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg overflow-hidden">
                <!-- 美化的标签页 -->
                <div class="flex border-b border-gray-200 bg-gray-50">
                    <button
                        @click="setTab('all')"
                        :class="['tab-button flex-1 tab-all', activeTab === 'all' ? 'active' : 'text-gray-500']">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
                        </svg>
                        全部
                        <span class="tab-badge" v-text="messages.length"></span>
                    </button>
                    <button
                        @click="setTab('chat')"
                        :class="['tab-button flex-1 tab-chat', activeTab === 'chat' ? 'active' : 'text-gray-500']">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z"/>
                        </svg>
                        弹幕
                        <span class="tab-badge" v-text="messages.filter(m => m.type === 'chat').length"></span>
                    </button>
                    <button
                        @click="setTab('gift')"
                        :class="['tab-button flex-1 tab-gift', activeTab === 'gift' ? 'active' : 'text-gray-500']">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        礼物
                        <span class="tab-badge" v-text="messages.filter(m => m.type === 'gift').length"></span>
                    </button>
                </div>

                <!-- 消息列表 -->
                <div class="messages-container p-3 sm:p-4 bg-gradient-to-b from-gray-50 to-white relative">
                    <!-- 加载中提示 -->
                    <div v-if="loadingMessages" class="text-center text-gray-400 py-12">
                        <svg class="animate-spin w-8 h-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p>加载消息中...</p>
                    </div>
                    <!-- 无消息提示 -->
                    <div v-else-if="filteredMessages.length === 0" class="text-center text-gray-400 py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <p>暂无消息</p>
                    </div>
                    <div
                        v-for="(msg, index) in filteredMessages"
                        :key="index"
                        :class="['message', getMessageClass(msg)]">
                        <div v-html="msg.content"></div>
                    </div>

                    <!-- 有新消息提示按钮 -->
                    <button
                        v-if="unreadCount > 0"
                        @click="scrollToBottom"
                        class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg flex items-center gap-2 transition-all duration-300 animate-bounce">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"/>
                        </svg>
                        <span v-text="`${unreadCount} 条新消息`"></span>
                    </button>
                </div>
            </div>

            <!-- 右侧：贡献榜 -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-gray-100 bg-gradient-to-r from-purple-50 to-pink-50">
                    <h2 class="text-lg font-bold text-gray-800">
                        <svg class="w-5 h-5 inline mr-2 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        贡献榜 TOP100
                    </h2>
                </div>
                <div class="contributor-container">
                    <div v-if="!stats.contributorInfo || stats.contributorInfo.length === 0" class="text-center text-gray-400 py-12">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                        </svg>
                        <p>暂无贡献数据</p>
                    </div>
                    <div
                        v-for="(contributor, index) in stats.contributorInfo"
                        :key="index"
                        class="p-3 sm:p-4 border-b border-gray-100 hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 transition-all duration-200">
                        <div class="flex items-center">
                            <div :class="['rank-badge mr-2 sm:mr-3 flex-shrink-0', getRankClass(contributor.rank)]" v-text="contributor.rank"></div>
                            <img
                                v-if="contributor.avatar"
                                :src="contributor.avatar"
                                class="w-10 h-10 rounded-full mr-2 sm:mr-3 ring-2 ring-purple-100 flex-shrink-0"
                                alt="用户头像">
                            <img
                                v-else
                                src="https://p3-pc.douyinpic.com/aweme/100x100/aweme-avatar/default-avatar.jpeg"
                                class="w-10 h-10 rounded-full mr-2 sm:mr-3 ring-2 ring-purple-100 flex-shrink-0"
                                alt="默认头像">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-1">
                                    <span class="font-semibold text-gray-800 truncate cursor-pointer hover:text-blue-600 transition-colors"
                                         @click="openUserMessagesModal(contributor.user_id, contributor.user)"
                                         v-text="contributor.user"></span>
                                    <img v-if="contributor.user_level"
                                         :src="'/level_img/level_' + contributor.user_level + '.png'"
                                         style="height: 18px; object-fit: contain; flex-shrink: 0;">
                                    <img v-if="contributor.fans_club_level"
                                         :src="'/fansclub_img/fansclub_' + contributor.fans_club_level + '.png'"
                                         style="height: 18px; object-fit: contain; flex-shrink: 0;">
                                </div>
                                <div class="text-sm text-gray-500">
                                    <svg class="w-3 h-3 inline mr-1 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    <span v-text="formatNumber(contributor.score)"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- 用户消息模态框 -->
    <div v-if="showUserMessagesModal" class="user-modal-overlay" @click.self="closeUserMessagesModal">
        <div class="user-modal-content">
            <!-- 用户信息头部 -->
            <div class="user-header">
                <div class="flex justify-between items-start mb-4">
                    <div class="flex items-center">
                        <img
                            v-if="userMessagesData.user.avatar"
                            :src="userMessagesData.user.avatar"
                            class="user-avatar-large mr-4">
                        <div v-else class="user-avatar-large flex items-center justify-center text-2xl font-bold mr-4"
                             v-text="(userMessagesData.user.nickname || userMessagesData.user.user_id || 'U').substring(0, 1)"></div>
                        <div>
                            <h2 class="text-xl font-bold flex items-center">
                                <span v-text="userMessagesData.user.nickname || userMessagesData.user.user_id"></span>
                                <img v-if="userMessagesData.user.level"
                                     :src="'/level_img/level_' + userMessagesData.user.level + '.png'"
                                     style="height: 20px; margin-left: 8px; object-fit: contain;">
                                <img v-if="userMessagesData.user.fans_club_level"
                                     :src="'/fansclub_img/fansclub_' + userMessagesData.user.fans_club_level + '.png'"
                                     style="height: 20px; margin-left: 4px; object-fit: contain;">
                            </h2>
                        </div>
                    </div>
                    <button @click="closeUserMessagesModal" class="user-modal-close-btn text-white text-opacity-80 hover:text-opacity-100 text-3xl leading-none">&times;</button>
                </div>

                <!-- 用户额外信息 -->
                <div v-if="userMessagesData.user.gender || userMessagesData.user.follower_count || userMessagesData.user.following_count || userMessagesData.user.age_range"
                     class="mt-3 text-sm text-white text-opacity-90">
                    <div class="flex items-center gap-3 mb-1">
                        <span v-if="userMessagesData.user.gender">
                            <span v-text="userMessagesData.user.gender === 1 ? '♂' : userMessagesData.user.gender === 2 ? '♀' : ''"></span>
                        </span>
                        <span v-if="userMessagesData.user.age_range" v-text="formatAgeRange(userMessagesData.user.age_range)"></span>
                    </div>
                    <div v-if="userMessagesData.user.following_count || userMessagesData.user.follower_count" class="flex items-center gap-1">
                        <span class="font-bold" v-text="formatNumber(userMessagesData.user.following_count || 0)"></span>
                        <span class="text-white text-opacity-70">关注</span>
                        <span class="text-white text-opacity-50 mx-1">·</span>
                        <span class="font-bold" v-text="formatNumber(userMessagesData.user.follower_count || 0)"></span>
                        <span class="text-white text-opacity-70">粉丝</span>
                    </div>
                </div>
            </div>

            <!-- 标签页 -->
            <div class="border-b">
                <div class="flex">
                    <button
                        @click="switchUserMessagesTab('all')"
                        :class="['user-tab-button flex-1', userMessagesTab === 'all' ? 'active' : '']">
                        全部消息
                        <span class="ml-2 px-2 py-0.5 bg-gray-100 rounded-full text-xs"
                              v-text="userMessagesData.stats.total_messages"></span>
                    </button>
                    <button
                        @click="switchUserMessagesTab('chat')"
                        :class="['user-tab-button flex-1', userMessagesTab === 'chat' ? 'active' : '']">
                        弹幕
                        <span class="ml-2 px-2 py-0.5 bg-blue-100 text-blue-600 rounded-full text-xs"
                              v-text="userMessagesData.stats.chat_count"></span>
                    </button>
                    <button
                        @click="switchUserMessagesTab('gift')"
                        :class="['user-tab-button flex-1', userMessagesTab === 'gift' ? 'active' : '']">
                        礼物
                        <span class="ml-2 px-2 py-0.5 bg-pink-100 text-pink-600 rounded-full text-xs"
                              v-text="userMessagesData.stats.gift_count"></span>
                    </button>
                </div>
            </div>

            <!-- 消息列表 -->
            <div class="p-4 user-messages-body">
                <div v-if="userMessagesLoading" class="user-messages-placeholder">
                    <div class="text-center text-gray-400">
                        <svg class="animate-spin w-8 h-8 mx-auto mb-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p>加载中...</p>
                    </div>
                </div>
                <div v-else-if="userMessagesData.messages.length === 0" class="user-messages-placeholder">
                    <div class="text-center text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
                        </svg>
                        <p>该用户暂无消息记录</p>
                    </div>
                </div>
                <div v-else class="user-messages-list user-messages-fade space-y-2" :key="userMessagesTab">
                    <div v-for="msg in userMessagesData.messages" :key="msg.id"
                         :class="['user-message-card', msg.type === 'gift' ? 'user-gift-card' : 'user-chat-card']">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center">
                                <img v-if="msg.user_level" :src="'/level_img/level_' + msg.user_level + '.png'"
                                     class="h-5 mr-1" style="width: 40px; object-fit: contain;">
                                <img v-if="msg.fans_club_level" :src="'/fansclub_img/fansclub_' + msg.fans_club_level + '.png'"
                                     style="height: 18px; object-fit: contain; vertical-align: middle; margin-right: 4px;">
                                <span class="font-medium text-blue-600 text-sm" v-text="msg.nickname || msg.user_id"></span>
                            </div>
                            <span class="text-gray-400 text-xs" v-text="formatUserMessageTime(msg.created_at)"></span>
                        </div>
                        <div v-if="msg.type === 'chat'" class="text-gray-700 text-sm" v-text="msg.content"></div>
                        <div v-else class="text-gray-700 text-sm">
                            送出 <span class="font-semibold text-pink-600" v-text="msg.gift_name"></span>
                            <span class="text-gray-500" v-text="' x' + msg.gift_count"></span>
                            <span class="ml-2 text-yellow-600 font-semibold" v-text="msg.diamond_count + ' 钻石'"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分页 -->
            <div v-if="userMessagesData.pagination.total_pages > 1" class="px-4 py-3 border-t flex items-center justify-between bg-gray-50">
                <div class="text-sm text-gray-500">
                    第 <span class="font-medium" v-text="userMessagesData.pagination.page"></span> /
                    <span v-text="userMessagesData.pagination.total_pages"></span> 页
                    (共 <span class="font-medium" v-text="userMessagesData.pagination.total"></span> 条)
                </div>
                <div class="flex items-center gap-2">
                    <button
                        @click="userMessagesGoToPage(userMessagesData.pagination.page - 1)"
                        :disabled="userMessagesData.pagination.page <= 1"
                        :class="['px-3 py-1 rounded text-sm', userMessagesData.pagination.page <= 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-gray-100 text-gray-700 hover:bg-gray-200']">
                        上一页
                    </button>
                    <button
                        @click="userMessagesGoToPage(userMessagesData.pagination.page + 1)"
                        :disabled="userMessagesData.pagination.page >= userMessagesData.pagination.total_pages"
                        :class="['px-3 py-1 rounded text-sm', userMessagesData.pagination.page >= userMessagesData.pagination.total_pages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-gray-100 text-gray-700 hover:bg-gray-200']">
                        下一页
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/room.js"></script>
</body>
</html>
